<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <title>TTS 체감 속도 비교</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 900px; margin: 24px auto; line-height: 1.5; }
    fieldset { border: 1px solid #ddd; border-radius: 12px; padding: 12px 16px; margin-bottom: 16px; }
    label { display: inline-block; min-width: 120px; }
    input, select, button { padding: 8px 10px; border: 1px solid #ccc; border-radius: 8px; }
    button { cursor: pointer; }
    .row { display: flex; gap: 12px; align-items: center; margin: 6px 0; }
    pre { background: #f7f7f7; padding: 12px; border-radius: 8px; overflow:auto; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .muted { color:#666; font-size: 0.9em; }
  </style>
</head>
<body>
  <h1>사용자 체감 속도 비교</h1>

  <fieldset>
    <legend>설정</legend>
    <div class="row">
      <label for="text">문장</label>
      <input id="text" size="50" value="안녕하세요, 테스트입니다. 체감 속도를 비교합니다.">
    </div>
    <div class="row">
      <label for="loops">반복(평균)</label>
      <input id="loops" type="number" min="1" max="50" value="3" style="width: 80px;">
    </div>
    <div class="row">
      <label for="serverUrl">서버 /tts URL</label>
      <input id="serverUrl" size="40" value="http://localhost:8000/api/tts">
    </div>
    <div class="row">
      <label for="speaker">서버 speaker</label>
      <input id="speaker" value="KR" style="width: 120px;">
      <label for="speed">speed</label>
      <input id="speed" type="number" step="0.1" min="0.5" max="2.0" value="1.0" style="width: 90px;">
    </div>
    <div class="row">
      <label for="wsVoice">Web Speech 음성</label>
      <select id="wsVoice"></select>
    </div>
    <div class="row">
      <button id="run">테스트 실행</button>
    </div>
  </fieldset>

  <div class="grid">
    <div>
      <h3>Web Speech API 결과</h3>
      <pre id="outWeb"></pre>
    </div>
    <div>
      <h3>서버 MeloTTS 결과</h3>
      <pre id="outSrv"></pre>
    </div>
  </div>

  <h3>비교 요약</h3>
  <pre id="summary"></pre>

  <audio id="serverAudio" controls></audio>

  <script>
    const sleep = ms => new Promise(r => setTimeout(r, ms));
    const stat = arr => {
      const a = [...arr].sort((x,y)=>x-y);
      const avg = a.reduce((s,x)=>s+x,0)/a.length;
      return {
        min: +a[0].toFixed(1),
        p50: +a[Math.floor(a.length*0.5)].toFixed(1),
        avg: +avg.toFixed(1),
        max: +a[a.length-1].toFixed(1),
      };
    };

    // === Web Speech ===
    const voiceSelect = document.getElementById('wsVoice');
    function loadVoices() {
      const voices = speechSynthesis.getVoices();
      voiceSelect.innerHTML = '';
      for (const v of voices) {
        const opt = document.createElement('option');
        opt.value = v.name;
        opt.textContent = `${v.name} (${v.lang})`;
        voiceSelect.appendChild(opt);
      }
      const idx = [...voiceSelect.options].findIndex(o => /ko-KR/i.test(o.textContent));
      if (idx >= 0) voiceSelect.selectedIndex = idx;
    }
    if (window.speechSynthesis) {
      loadVoices();
      window.speechSynthesis.onvoiceschanged = loadVoices;
    }

    function testWebSpeech(text, voiceName) {
      return new Promise((resolve, reject) => {
        const u = new SpeechSynthesisUtterance(text);
        const vs = speechSynthesis.getVoices();
        const v = vs.find(v => v.name === voiceName) || vs.find(v => /ko-KR/i.test(v.lang));
        if (v) u.voice = v;
        const t0 = performance.now();
        let tStart = null;
        u.onstart = () => { tStart = performance.now(); };
        u.onend   = () => {
          resolve({
            first_sound_ms: tStart ? (tStart - t0) : null,
            total_ms: performance.now() - t0
          });
        };
        u.onerror = (e) => reject(e.error || e);
        speechSynthesis.cancel();
        speechSynthesis.speak(u);
      });
    }

    // === 서버 TTS ===
    async function testServerTTS(url, text, speaker, speed) {
      const audioEl = document.getElementById('serverAudio');
      audioEl.pause(); audioEl.removeAttribute('src'); audioEl.load();

      const t0 = performance.now();
      let ttfb_ms = null;

      const resp = await fetch(url, {
        method: 'POST',
        headers: {'content-type':'application/json'},
        body: JSON.stringify({ text, speed: Number(speed), speaker, return_base64: false })
      });

      const reader = resp.body?.getReader?.();
      let chunks = [];
      if (reader) {
        const first = await reader.read();
        ttfb_ms = performance.now() - t0;
        if (!first.done) chunks.push(first.value);
        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          chunks.push(value);
        }
        const blob = new Blob(chunks, { type: 'audio/wav' });
        audioEl.src = URL.createObjectURL(blob);
      } else {
        const blob = await resp.blob();
        ttfb_ms = performance.now() - t0;
        audioEl.src = URL.createObjectURL(blob);
      }

      const tPlay = await new Promise((resolve) => {
        audioEl.addEventListener('playing', () => resolve(performance.now()), { once: true });
        audioEl.play().catch(()=>{});
      });

      return {
        ttfb_ms,
        first_sound_ms: tPlay - t0
      };
    }

    // === 실행 ===
    document.getElementById('run').addEventListener('click', async () => {
      const text  = document.getElementById('text').value.trim();
      const loops = Math.max(1, Number(document.getElementById('loops').value || 1));
      const serverUrl = document.getElementById('serverUrl').value.trim();
      const speaker = document.getElementById('speaker').value.trim();
      const speed = document.getElementById('speed').value.trim();
      const voiceName = document.getElementById('wsVoice').value;

      const outWeb = document.getElementById('outWeb');
      const outSrv = document.getElementById('outSrv');
      const summary = document.getElementById('summary');

      outWeb.textContent = '실행 중...'; outSrv.textContent = '실행 중...'; summary.textContent = '';

      const webStart = [], webTotal = [];
      const srvTTFB = [], srvStart = [];

      for (let i=0; i<loops; i++) {
        try {
          const w = await testWebSpeech(text, voiceName);
          if (w.first_sound_ms != null) webStart.push(w.first_sound_ms);
          webTotal.push(w.total_ms);
        } catch {}
        try {
          const s = await testServerTTS(serverUrl, text, speaker, speed);
          srvTTFB.push(s.ttfb_ms);
          srvStart.push(s.first_sound_ms);
          await sleep(300);
        } catch {}
      }

      outWeb.textContent = JSON.stringify({
        first_sound_ms: stat(webStart),
        total_ms: stat(webTotal)
      }, null, 2);

      outSrv.textContent = JSON.stringify({
        ttfb_ms: stat(srvTTFB),
        first_sound_ms: stat(srvStart)
      }, null, 2);

      const wAvg = webStart.reduce((a,b)=>a+b,0)/Math.max(1, webStart.length);
      const sAvg = srvStart.reduce((a,b)=>a+b,0)/Math.max(1, srvStart.length);

      summary.textContent = JSON.stringify({
        web_first_sound_avg_ms: isFinite(wAvg) ? +wAvg.toFixed(1) : 'N/A',
        server_first_sound_avg_ms: isFinite(sAvg) ? +sAvg.toFixed(1) : 'N/A',
        slowdown_ms: (isFinite(wAvg) && isFinite(sAvg)) ? +(sAvg-wAvg).toFixed(1) : 'N/A'
      }, null, 2);
    });
  </script>
</body>
</html>
